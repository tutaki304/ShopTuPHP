================================================================
                    C∆† CH·∫æ GI·ªé H√ÄNG TH√îNG MINH TRONG SHOPTUPHP
================================================================

üõí KH√îNG C√ì B·∫¢NG "GIOHANG" RI√äNG - D√ôNG B·∫¢NG "HOADON"!
=======================================================

H·ªá th·ªëng s·ª≠ d·ª•ng k·ªπ thu·∫≠t r·∫•t th√¥ng minh ƒë·ªÉ qu·∫£n l√Ω gi·ªè h√†ng:

üìã C·∫§U TR√öC DATABASE
====================

-- B·∫¢NG HOADON (ƒê√≥ng vai tr√≤ c·∫£ Order v√† Cart)
CREATE TABLE `hoadon` (
  `mahd` int(11) NOT NULL AUTO_INCREMENT,
  `makh` int(11) NOT NULL,           -- ID kh√°ch h√†ng
  `ngaydathang` datetime DEFAULT NULL,
  `tongtien` int(11) DEFAULT NULL,
  `ghichu` text,
  `trangthai` varchar(50) DEFAULT NULL,  -- KEY POINT: 'gio-hang' ho·∫∑c 'da-thanh-toan'
  PRIMARY KEY (`mahd`)
);

-- B·∫¢NG CHITIETHOADON (Chi ti·∫øt s·∫£n ph·∫©m trong gi·ªè h√†ng/ƒë∆°n h√†ng)
CREATE TABLE `chitiethoadon` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `mahd` int(11) NOT NULL,           -- ID h√≥a ƒë∆°n (li√™n k·∫øt v·ªõi hoadon)
  `masp` int(11) NOT NULL,           -- ID s·∫£n ph·∫©m
  `soluong` int(11) NOT NULL,        -- S·ªë l∆∞·ª£ng s·∫£n ph·∫©m
  PRIMARY KEY (`id`)
);

üéØ LOGIC HO·∫†T ƒê·ªòNG
==================

1. üõí GI·ªé H√ÄNG = HOADON v·ªõi `trangthai = 'gio-hang'`
--------------------------------------------------

// Ki·ªÉm tra c√≥ gi·ªè h√†ng ch∆∞a
function get_hasCart($makh){
    return pdo_query_one("SELECT * FROM hoadon WHERE makh=? AND trangthai=?", 
                         $makh, 'gio-hang');
}

2. üì¶ S·∫¢N PH·∫®M TRONG GI·ªé = CHITIETHOADON
---------------------------------------

// Hi·ªÉn th·ªã gi·ªè h√†ng
function get_Cart($makh){
    return pdo_query("SELECT hd.mahd, ct.soluong, sp.masp, sp.tensp, sp.anh, sp.dongia 
                     FROM hoadon hd 
                     INNER JOIN chitiethoadon ct ON hd.mahd = ct.mahd 
                     INNER JOIN sanpham sp ON ct.masp = sp.masp 
                     WHERE hd.makh=? AND hd.trangthai=?", $makh, 'gio-hang');
}

3. ‚ûï TH√äM V√ÄO GI·ªé H√ÄNG
-----------------------

// Flow th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng
if (isset($_SESSION['user'])) {
    $makh = $_SESSION['user']['makh'];
    
    // 1. Ki·ªÉm tra c√≥ gi·ªè h√†ng ch∆∞a
    $cart = get_hasCart($makh);
    
    if ($cart) {
        // 2. C√≥ r·ªìi ‚Üí Th√™m s·∫£n ph·∫©m v√†o chitiethoadon
        get_addToCart($cart['mahd'], $masp);
    } else {
        // 3. Ch∆∞a c√≥ ‚Üí T·∫°o m·ªõi hoadon v·ªõi trangthai='gio-hang'
        get_cartAdd($makh);
        $new_cart = get_hasCart($makh);
        get_addToCart($new_cart['mahd'], $masp);
    }
}

4. üîß C√ÅC FUNCTIONS CH·ª¶ ƒê·∫†O
---------------------------

// T·∫°o gi·ªè h√†ng m·ªõi
function get_cartAdd($makh){
    pdo_execute("INSERT INTO hoadon(`makh`,`ngaydathang`,`tongtien`,`ghichu`,`trangthai`) 
                VALUES(?,?,?,?,?)", $makh, date('Y-m-d H:i:s'), 0, '', 'gio-hang');
}

// Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng
function get_addToCart($mahd, $masp, $soluong = 1){
    // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
    $existing = pdo_query_one("SELECT * FROM chitiethoadon WHERE mahd=? AND masp=?", $mahd, $masp);
    
    if($existing) {
        // N·∫øu ƒë√£ c√≥, ch·ªâ c·ªông th√™m 1
        $newQuantity = $existing['soluong'] + 1;
        pdo_execute("UPDATE chitiethoadon SET soluong=? WHERE mahd=? AND masp=?", 
                   $newQuantity, $mahd, $masp);
    } else {
        // N·∫øu ch∆∞a c√≥, th√™m m·ªõi v·ªõi s·ªë l∆∞·ª£ng = 1
        pdo_execute("INSERT INTO chitiethoadon(`mahd`,`masp`,`soluong`) VALUES(?,?,?)", 
                   $mahd, $masp, 1);
    }
}

// C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
function get_updateCartQuantity($mahd, $masp, $soluong){
    if($soluong <= 0) {
        // N·∫øu s·ªë l∆∞·ª£ng <= 0, x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
        get_removeFromCart($mahd, $masp);
    } else {
        pdo_execute("UPDATE chitiethoadon SET soluong=? WHERE mahd=? AND masp=?", 
                   $soluong, $mahd, $masp);
    }
}

// L·∫•y t·ªïng s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè h√†ng
function get_cartTotalQuantity($makh){
    $result = pdo_query_one("SELECT SUM(ct.soluong) as total FROM hoadon hd 
                            INNER JOIN chitiethoadon ct ON hd.mahd = ct.mahd 
                            WHERE hd.makh=? AND hd.trangthai=?", $makh, 'gio-hang');
    return $result ? (int)$result['total'] : 0;
}

// L·∫•y t·ªïng ti·ªÅn gi·ªè h√†ng
function get_cartTotalPrice($makh){
    $result = pdo_query_one("SELECT SUM(ct.soluong * (sp.khuyenmai * 1000)) as total 
                            FROM hoadon hd 
                            INNER JOIN chitiethoadon ct ON hd.mahd = ct.mahd 
                            INNER JOIN sanpham sp ON ct.masp = sp.masp
                            WHERE hd.makh=? AND hd.trangthai=?", $makh, 'gio-hang');
    return $result ? (int)$result['total'] : 0;
}

// Xo√° s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
function get_removeFromCart($mahd, $masp){
    pdo_execute("DELETE FROM chitiethoadon WHERE mahd=? AND masp=?",$mahd, $masp);
}

üîÑ LU·ªíNG CHUY·ªÇN TR·∫†NG TH√ÅI
=========================

üë§ User login ‚Üí üõí Gi·ªè h√†ng ‚Üí üí≥ Thanh to√°n ‚Üí üì¶ ƒê∆°n h√†ng
   
   HOADON table:
   trangthai = 'gio-hang'  ‚Üí  trangthai = 'da-thanh-toan'

// Khi thanh to√°n - chuy·ªÉn t·ª´ gi·ªè h√†ng th√†nh ƒë∆°n h√†ng
function checkout($mahd) {
    pdo_execute("UPDATE hoadon SET trangthai='da-thanh-toan', ngaydathang=NOW() 
                WHERE mahd=?", $mahd);
}

üìä DEMO TH·ª∞C T·∫æ
===============

-- User ID 1 c√≥ gi·ªè h√†ng
SELECT * FROM hoadon WHERE makh=1 AND trangthai='gio-hang';
-- Result: mahd=101, makh=1, trangthai='gio-hang'

-- S·∫£n ph·∫©m trong gi·ªè h√†ng
SELECT * FROM chitiethoadon WHERE mahd=101;
-- Result: masp=5 (quantity=2), masp=8 (quantity=1)

-- Khi thanh to√°n
UPDATE hoadon SET trangthai='da-thanh-toan' WHERE mahd=101;
-- Gi·ªè h√†ng th√†nh ƒë∆°n h√†ng!

üß† PH√ÇN T√çCH THI·∫æT K·∫æ
====================

‚úÖ ∆ØU ƒêI·ªÇM:
-----------
1. **Ti·∫øt ki·ªám b·∫£ng**: Kh√¥ng c·∫ßn t·∫°o b·∫£ng gi·ªè h√†ng ri√™ng
2. **Logic th·ªëng nh·∫•t**: Gi·ªè h√†ng = ƒë∆°n h√†ng ch∆∞a thanh to√°n
3. **D·ªÖ tracking**: Theo d√µi to√†n b·ªô lifecycle t·ª´ cart ‚Üí order
4. **Persistent cart**: Gi·ªè h√†ng kh√¥ng m·∫•t khi logout
5. **ƒê∆°n gi·∫£n h√≥a**: C√πng structure cho cart v√† order
6. **Ti·∫øt ki·ªám storage**: Kh√¥ng duplicate data structure
7. **Maintainable**: D·ªÖ maintain v√¨ logic t·∫≠p trung

‚ùå NH∆Ø·ª¢C ƒêI·ªÇM:
--------------
1. **Confusing**: Logic h∆°i ph·ª©c t·∫°p cho ng∆∞·ªùi m·ªõi
2. **Mixed responsibility**: 1 b·∫£ng ƒë·∫£m nh·∫≠n 2 vai tr√≤
3. **Query ph·ª©c t·∫°p**: Lu√¥n ph·∫£i filter theo trangthai
4. **Performance**: C√≥ th·ªÉ ch·∫≠m khi data l·ªõn (c·∫ßn index)
5. **Scalability**: Kh√≥ scale khi c√≥ nhi·ªÅu lo·∫°i tr·∫°ng th√°i

üîç C√ÅC TR·∫†NG TH√ÅI TRONG H·ªÜ TH·ªêNG
================================

1. **'gio-hang'** - Gi·ªè h√†ng ƒëang active
2. **'da-thanh-toan'** - ƒê∆°n h√†ng ƒë√£ thanh to√°n
3. **'dang-xu-ly'** - ƒê∆°n h√†ng ƒëang x·ª≠ l√Ω
4. **'da-giao'** - ƒê√£ giao h√†ng
5. **'da-huy'** - ƒê∆°n h√†ng b·ªã h·ªßy

üí° PATTERN DESIGN T∆Ø∆†NG T·ª∞
==========================

ƒê√¢y l√† pattern "State Machine" trong database design:
- 1 entity c√≥ th·ªÉ c√≥ nhi·ªÅu states
- State transition ƒë∆∞·ª£c control b·ªüi business logic
- Ti·∫øt ki·ªám ƒë∆∞·ª£c tables v√† relationships ph·ª©c t·∫°p

üöÄ C√ÅCH C·∫¢I TI·∫æN
================

N·∫øu mu·ªën c·∫£i ti·∫øn h·ªá th·ªëng n√†y:

1. **Th√™m index cho performance:**
   CREATE INDEX idx_hoadon_user_status ON hoadon(makh, trangthai);

2. **Th√™m validation logic:**
   - Prevent multiple active carts per user
   - Validate quantity before add to cart
   - Check product availability

3. **Th√™m audit trail:**
   - Log cart activities
   - Track price changes
   - Monitor abandoned carts

4. **Optimize queries:**
   - Use materialized views for complex calculations
   - Cache total prices and quantities

================================================================
                            K·∫æT LU·∫¨N
================================================================

ƒê√¢y l√† m·ªôt PATTERN THI·∫æT K·∫æ R·∫§T TH√îNG MINH ƒë·ªÉ t·ªëi ∆∞u h√≥a database 
structure trong d·ª± √°n e-commerce nh·ªè v√† trung b√¨nh. M·∫∑c d√π c√≥ m·ªôt 
s·ªë trade-offs, nh∆∞ng benefits v∆∞·ª£t tr·ªôi h∆°n drawbacks trong context 
c·ªßa ShopTuPHP.

Ki·∫øn tr√∫c n√†y cho th·∫•y s·ª± hi·ªÉu bi·∫øt s√¢u s·∫Øc v·ªÅ database design v√† 
business logic optimization c·ªßa developer.

================================================================
T√°c gi·∫£: tutaki304
Ng√†y t·∫°o: August 10, 2025
Project: ShopTuPHP E-commerce System
================================================================
